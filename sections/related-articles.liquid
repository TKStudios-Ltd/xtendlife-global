{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-article-card.css' | asset_url | stylesheet_tag }}
{{ 'section-featured-blog.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
  @media (max-width: 989px) {
    .section-{{ section.id }}-padding { flex-direction: column; }
    .section-{{ section.id }}-padding .swiper-slide:first-child { padding-left: 2rem; }
    .section-{{ section.id }}-padding .swiper-pagination-progressbar { margin: 4rem 2rem 0; width: calc(100% - 4rem) !important; }
    .section-{{ section.id }}-padding .title-wrapper-with-link {
      flex: 0 0 100%; width: calc(100% - 4rem); display: flex; align-items: flex-start; justify-content: space-between; margin: 0 2rem;
    }
    .section-{{ section.id }}-padding .swiper-slide.swiper-slide-active { opacity: 1; }
    .section-{{ section.id }}-padding .swiper-slide { opacity: 0.5; transition: opacity ease .4s; }
  }
  @media (max-width: 749px) {
    .section-{{ section.id }}-padding .title-wrapper-with-link h2 { max-width: 200px; line-height: 1; }
  }
  .section-{{ section.id }}-padding { display: flex; align-items: flex-start; gap: 2rem; }
  .section-{{ section.id }}-padding .blog__content { width: 100%; }
  .section-{{ section.id }}-padding .grid__item.article .article-card-wrapper { width: 100%; }
  @media (min-width: 990px) {
    .section-{{ section.id }}-padding .title-wrapper-with-link { flex:0 0 25%; }
    .section-{{ section.id }}-padding .blog__content { flex: 0 0 calc(75% - 2rem); }
    .section-{{ section.id }}-padding .blog__view-all { margin-top: 1.5rem; }
    .section-{{ section.id }}-padding .articles-wrapper { margin-top: 0; }
  }

  /* Mobile/Tablet Swiper */
  .fb-mobile { overflow:hidden; width:100%; position:relative; }
  .fb-mobile .swiper { overflow:visible; }
  .fb-mobile .swiper-wrapper { display:flex; }
  .fb-mobile .swiper-slide { height:auto; }
{%- endstyle -%}

{%- liquid
  assign use_auto = section.settings.auto_from_article
  assign source_blog = section.settings.blog

  if use_auto and template.name == 'article'
    assign source_blog = blog
  endif

  if source_blog == blank
    echo '<div class="page-width"><p>Add a Blog in section settings.</p></div>'
    break
  endif

  assign posts_displayed = source_blog.articles_count
  if section.settings.post_limit <= source_blog.articles_count or section.settings.post_limit <= 4
    assign posts_exceed_limit = true
    assign posts_displayed = section.settings.post_limit
  endif

  assign rel_tag = ''
  assign rel_handle = ''

  if use_auto and template.name == 'article'
    comment
      Choose related tag: Label:: override first, else first Uppercase-starting tag
    endcomment
    for t in article.tags
      if t contains 'Label::'
        assign rel_tag = t | split: '::' | last
        break
      endif
    endfor

    if rel_tag == ''
      for t in article.tags
        assign fc = t | slice: 0, 1
        assign fcu = fc | upcase
        if fc == fcu
          assign rel_tag = t
          break
        endif
      endfor
    endif

    assign rel_handle = rel_tag | handleize
  endif
-%}

{%- if section.settings.hide_if_empty and use_auto and rel_tag == '' and template.name == 'article' -%}
  {% break %}
{%- endif -%}

<div class="blog color-{{ section.settings.color_scheme }} gradient{% if section.settings.heading == blank %} no-heading{% endif %}">
  <div class="page-width-desktop isolate{% if posts_displayed < 3 %} page-width-tablet{% endif %}">
    <div class="section-{{ section.id }}-padding border-top">

    {%- if section.settings.heading != blank -%}
    <div class="title-wrapper-with-link title-wrapper--no-top-margin">
        <h2
        id="SectionHeading-{{ section.id }}"
        class="blog__title inline-richtext {{ section.settings.heading_size }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
        {% if settings.animations_reveal_on_scroll %} data-cascade {% endif %}
        >
        {{ section.settings.heading }}
        </h2>
        {%- if source_blog != blank
        and section.settings.show_view_all
        and section.settings.post_limit < source_blog.articles_count
        -%}
        <div class="blog__view-all large-up-hide">
            <a
            href="{{ source_blog.url }}"
            id="ViewAll-{{ section.id }}"
            class="blog__button button button--secondary"
            aria-labelledby="ViewAll-{{ section.id }} SectionHeading-{{ section.id }}"
            >
            Read more
            </a>
        </div>
        {%- endif -%}
    </div>
    {%- elsif use_auto and rel_tag != '' -%}
    <div class="title-wrapper-with-link title-wrapper--no-top-margin">
        <h2
        id="SectionHeading-{{ section.id }}"
        class="blog__title inline-richtext {{ section.settings.heading_size }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
        {% if settings.animations_reveal_on_scroll %} data-cascade {% endif %}
        >
        {{ section.settings.auto_heading_prefix | default: 'Related in' }} {{ rel_tag }}
        </h2>
        {%- if source_blog != blank
        and section.settings.show_view_all
        and section.settings.post_limit < source_blog.articles_count
        -%}
        <div class="blog__view-all large-up-hide">
            <a
            href="{{ source_blog.url }}/tagged/{{ rel_handle }}"
            id="ViewAll-{{ section.id }}"
            class="blog__button button button--secondary"
            aria-labelledby="ViewAll-{{ section.id }} SectionHeading-{{ section.id }}"
            >
            Read more
            </a>
        </div>
        {%- endif -%}
    </div>
    {%- endif -%}


    <div class="blog__content">
      {%- comment -%} Desktop grid (≥ 990px) {%- endcomment -%}
      <ul
        class="articles-wrapper contains-card contains-card--article{% if settings.blog_card_style == 'standard' %} contains-card--standard{% endif %} grid grid--{{ section.settings.columns_desktop }}-col-desktop small-hide medium-hide"
        role="list"
      >
        {%- assign rendered = 0 -%}
        {%- if source_blog != blank and source_blog.articles_count > 0 -%}
        {%- for a in source_blog.articles -%}
            {%- assign include_article = false -%}

            {%- if use_auto and rel_handle != '' and template.name == 'article' -%}
            {%- if a.id != article.id -%}
                {%- for at in a.tags -%}
                {%- assign first_char = at | slice: 0, 1 -%}
                {%- assign first_char_up = first_char | upcase -%}
                {%- assign at_handle = at | handleize -%}
                {%- if first_char == first_char_up and at_handle == rel_handle -%}
                    {%- assign include_article = true -%}
                    {%- break -%}
                {%- endif -%}
                {%- endfor -%}
            {%- endif -%}
            {%- else -%}
            {%- assign include_article = true -%}
            {%- endif -%}

            {%- if include_article -%}
            <li class="grid__item article">
                {% render 'article-card',
                blog: source_blog,
                article: a,
                media_aspect_ratio: 1.66,
                show_image: section.settings.show_image,
                show_date: section.settings.show_date,
                show_author: section.settings.show_author,
                show_excerpt: true
                %}
            </li>
            {%- assign rendered = rendered | plus: 1 -%}
            {%- if rendered >= section.settings.post_limit -%}{% break %}{%- endif -%}
            {%- endif -%}
        {%- endfor -%}
        {%- endif -%}

      </ul>

      {%- comment -%} Mobile/Tablet Swiper (< 990px) {%- endcomment -%}
      <div class="fb-mobile large-up-hide">
        <div class="swiper" id="fb-swiper-{{ section.id }}">
            <div class="swiper-wrapper">
                {%- assign rendered_m = 0 -%}
                {%- if source_blog != blank and source_blog.articles_count > 0 -%}
                {%- for a in source_blog.articles -%}
                    {%- assign include = false -%}

                    {%- if use_auto and rel_handle != '' and template.name == 'article' -%}
                    {%- if a.id != article.id -%}
                        {%- for at in a.tags -%}
                        {%- assign first_char = at | slice: 0, 1 -%}
                        {%- assign first_char_up = first_char | upcase -%}
                        {%- assign at_handle = at | handleize -%}
                        {%- if first_char == first_char_up and at_handle == rel_handle -%}
                            {%- assign include = true -%}
                            {%- break -%}
                        {%- endif -%}
                        {%- endfor -%}
                    {%- endif -%}
                    {%- else -%}
                    {%- assign include = true -%}
                    {%- endif -%}

                    {%- if include -%}
                    <div class="swiper-slide">
                        {% render 'article-card',
                        blog: source_blog,
                        article: a,
                        media_aspect_ratio: 1.66,
                        show_image: section.settings.show_image,
                        show_date: section.settings.show_date,
                        show_author: section.settings.show_author,
                        show_excerpt: true
                        %}
                    </div>
                    {%- assign rendered_m = rendered_m | plus: 1 -%}
                    {%- if rendered_m >= section.settings.post_limit -%}{% break %}{%- endif -%}
                    {%- endif -%}
                {%- endfor -%}
                {%- endif -%}

                {%- if rendered_m == 0 -%}
                {%- unless section.settings.hide_if_empty -%}
                    {% for i in (1..section.settings.post_limit) -%}
                    {%- assign placeholder_image_index = forloop.index0 | modulo: 3 | plus: 1 -%}
                    {%- assign placeholder_image = 'blog-apparel-' | append: placeholder_image_index -%}
                    <div class="swiper-slide">
                        <div class="article-card-wrapper card-wrapper">
                        <div class="card article-card {% if settings.blog_card_style == 'card' %} color-{{ settings.blog_card_color_scheme }} gradient{% endif %} {% if section.settings.show_image %} card--media{% else %} card--text{% endif %}">
                            <div class="card__inner{% if settings.blog_card_style == 'standard' %} color-{{ settings.blog_card_color_scheme }} gradient{% endif %} ratio" style="--ratio-percent: 80%;">
                            {%- if section.settings.show_image -%}
                                <div class="article-card__image-wrapper card__media">
                                <div class="article-card__image media">
                                    {{ placeholder_image | placeholder_svg_tag: 'blog-placeholder-svg' }}
                                </div>
                                </div>
                            {%- endif -%}
                            <div class="card__content"><div class="card__information"><h3 class="card__heading h3">{{ 'sections.featured_blog.onboarding_title' | t }}</h3></div></div>
                            </div>
                            <div class="card__content"><div class="card__information"><h3 class="card__heading h3">{{ 'sections.featured_blog.onboarding_title' | t }}</h3></div></div>
                        </div>
                        </div>
                    </div>
                    {%- endfor -%}
                {%- endunless -%}
                {%- endif -%}
            </div>
            </div>
        <div id="fb-pagination-{{ section.id }}" class="swiper-pagination"></div>
      </div>

      {%- if source_blog != blank
        and section.settings.show_view_all
        and section.settings.post_limit < source_blog.articles_count
      -%}
        <div class="blog__view-all small-hide medium-hide">
          <a
            href="{% if use_auto and rel_tag != '' %}{{ source_blog.url }}/tagged/{{ rel_handle }}{% else %}{{ source_blog.url }}{% endif %}"
            id="ViewAll-{{ section.id }}"
            class="blog__button button button--secondary"
            aria-labelledby="ViewAll-{{ section.id }} SectionHeading-{{ section.id }}"
          >
            Read more
          </a>
        </div>
      {%- endif -%}
    </div>
    </div>
  </div>
</div>

<script>
(function(){
  const el = document.querySelector('#fb-swiper-{{ section.id }}');
  if (!el) return;

  function init(){
    if (typeof window.Swiper === 'undefined') { setTimeout(init, 50); return; }
    if (el.dataset.swiperReady === '1') return;

    const sw = new Swiper(el, {
      slidesPerView: 1.3,
      spaceBetween: 20,
      speed: 500,
      watchOverflow: true,
      breakpoints: { 750: { slidesPerView: 2.3 } },
      pagination: { el: '#fb-pagination-{{ section.id }}', type: 'progressbar' }
    });

    el.dataset.swiperReady = '1';

    const update = () => { try { sw.update(); } catch(e) {} };
    window.addEventListener('load', update, { once:true, passive:true });
    el.querySelectorAll('img').forEach(img => {
      if (!img.complete) img.addEventListener('load', update, { once:true, passive:true });
    });
  }
  init();
})();
</script>

{% schema %}
{
  "name": "Related articles",
  "tag": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "checkbox", "id": "auto_from_article", "label": "Auto filter from current article tag", "default": true, "info": "On article pages, show related posts with the same category tag (Label:: override or first uppercase tag). Else, falls back to the selected blog below." },

    { "type": "blog", "id": "blog", "label": "Blog (fallback / non-article pages)" },

    { "type": "header", "content": "Heading" },
    { "type": "inline_richtext", "id": "heading", "default": "Latest stories", "label": "Heading (non-auto mode)" },
    { "type": "text", "id": "auto_heading_prefix", "label": "Auto heading prefix", "default": "Related in" },
    { "type": "select", "id": "heading_size",
      "options": [
        { "value": "h2", "label": "H2" },
        { "value": "h1", "label": "H1" },
        { "value": "h0", "label": "H0" },
        { "value": "hxl", "label": "HXL" },
        { "value": "hxxl", "label": "HXXL" }
      ],
      "default": "h1",
      "label": "Heading size"
    },

    { "type": "header", "content": "Layout" },
    { "type": "range", "id": "columns_desktop", "min": 1, "max": 4, "step": 1, "default": 3, "label": "Columns on desktop" },
    { "type": "range", "id": "post_limit", "min": 2, "max": 12, "step": 1, "default": 6, "label": "Max posts to show" },
    { "type": "checkbox", "id": "show_view_all", "default": true, "label": "Show “Read more” button" },
    { "type": "checkbox", "id": "hide_if_empty", "default": true, "label": "Hide section if no related posts" },

    { "type": "header", "content": "Card options" },
    { "type": "checkbox", "id": "show_image", "default": true, "label": "Show image" },
    { "type": "checkbox", "id": "show_date", "default": true, "label": "Show date" },
    { "type": "checkbox", "id": "show_author", "default": false, "label": "Show author" },

    { "type": "header", "content": "Colors" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "info": "Has cards info", "default": "scheme-1" },

    { "type": "header", "content": "Spacing" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Top padding", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Bottom padding", "default": 36 }
  ],
  "presets": [
    { "name": "Related articles" }
  ]
}
{% endschema %}
